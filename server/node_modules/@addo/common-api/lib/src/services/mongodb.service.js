"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MongoDBService = void 0;
const typy_1 = require("typy");
const _ = __importStar(require("lodash"));
const mongodb_1 = require("mongodb");
const mongodb_utils_1 = require("../utils/mongodb.utils");
const http_error_1 = require("../utils/http.error");
const specialOps = {
    $addToSet: (key, value) => {
        let $addToSet = {};
        $addToSet[key] = value;
        return { $addToSet };
    },
    $push: (key, value) => {
        let $push = {};
        $push[key] = value;
        return { $push };
    },
    $pop: (key, value) => {
        let $pop = {};
        $pop[key] = value;
        return { $pop };
    },
    $pull: (key, value) => {
        let $pull = {};
        $pull[key] = value;
        return { $pull };
    },
};
class MongoDBService {
    constructor(connectionPool) {
        this.connectionPool = connectionPool;
        this.exclude_fields = [];
        this.includes = {};
        this.sorts = {};
        this.pre_include = [];
        this.private_fields = [];
        this.CRUD_CONFIG = {
            exclude: {
                update: ["created"],
                isToBeSkipped: (path, op) => {
                    return (this.CRUD_CONFIG.exclude[op].find((u) => {
                        u = u.indexOf(".*") > -1 ? u.replace(".*", "") : u;
                        return path.indexOf(u) > -1;
                    }) != null);
                },
            },
        };
    }
    async find(filter, skip, take, fields, orderBy, includes = [], ctx = {}) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let aggregate = this.getAggregate(filter, includes, orderBy, ctx || {});
        return await client
            .db()
            .collection(this.collection)
            .aggregate(aggregate)
            .sort(orderBy)
            .skip(skip)
            .limit(take)
            .project(mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields))
            .toArray()
            .then((res) => {
            for (let r of res) {
                this.transform(r);
            }
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async findById(id, fields, includes = [], ctx = {}) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let aggregate = [{ $match: { _id: new mongodb_1.ObjectId(id) } }];
        this.addIncludes(aggregate, includes, ctx || {});
        return await client
            .db()
            .collection(this.collection)
            .aggregate(aggregate)
            .project(mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields))
            .toArray()
            .then((res) => {
            if (res[0]) {
                res[0] = this.transform(res[0]);
            }
            return res[0];
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async findOne(filter, fields, includes = [], ctx = {}) {
        let aggregate = this.getAggregate(filter, includes, {}, ctx || {});
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        return await client
            .db()
            .collection(this.collection)
            .aggregate(aggregate)
            .skip(0)
            .limit(1)
            .project(mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields))
            .toArray()
            .then((res) => {
            if (res[0]) {
                res[0] = this.transform(res[0]);
            }
            return res[0];
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async add(entity) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        try {
            let result = await collection.insertOne(entity);
            return collection
                .findOne({ _id: result.insertedId })
                .then((res) => {
                if (res) {
                    res = this.transform(res);
                }
                return res;
            })
                .catch((err) => {
                throw new http_error_1.HttpError(err.message, err, 500);
            });
        }
        catch (err) {
            throw new http_error_1.HttpError(err.message, err, 500);
        }
    }
    async updateFromId(entity, updateFields, fields, ctx = {}) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        let $update = {};
        let $set = {};
        updateFields = updateFields.replace(/,/g, " ");
        fields = fields.replace(/,/g, " ");
        for (let field of updateFields.split(" ")) {
            if (this.CRUD_CONFIG.exclude.isToBeSkipped(field, "update"))
                continue;
            if (field[0] == "$") {
                let matches = field.split(":");
                let key = matches[1];
                let value = _.get(entity, key);
                if (matches[2] && matches[2][0] == ".") {
                    value = ctx[matches[2].replace(".", "")];
                }
                Object.assign($update, specialOps[matches[0]](key, value));
                console.log("Special update data: ", {
                    matches,
                    key,
                    value,
                    $set,
                    ctx,
                });
                continue;
            }
            _.set($set, field, typy_1.t(entity, field).safeObject);
        }
        if (Object.keys($set).length > 0) {
            $update.$set = $set;
        }
        return collection
            .findOneAndUpdate({ _id: new mongodb_1.ObjectId(entity.id) }, $update, {
            projection: mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields),
        })
            .then((result) => {
            let res = result.value;
            if (res) {
                res = this.transform(res);
            }
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async updateOne(filter, $update, fields, ctx = {}) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        return collection
            .findOneAndUpdate(filter, $update, {
            projection: mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields),
        })
            .then((result) => {
            let res = result.value;
            if (res) {
                res = this.transform(res);
            }
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async updateMany(conditions, entity, updateFields, fields) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        let $set = {};
        updateFields = updateFields.replace(/,/g, " ");
        fields = fields.replace(/,/g, " ");
        for (let field of updateFields.split(" ")) {
            if (this.CRUD_CONFIG.exclude.isToBeSkipped(field, "update"))
                continue;
            if (field[0] == "$") {
                let specialOp = field.split(":")[0];
                let key = field.split(":")[1];
                Object.assign($set, specialOps[specialOp](key, _.get(entity, key)));
                continue;
            }
            _.set($set, field, typy_1.t(entity, field).safeObject);
        }
        return collection
            .updateMany(conditions, { $set })
            .then((result) => {
            let res = result.result;
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async delete(id, fields) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        return collection
            .findOneAndDelete({ _id: id }, { projection: mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields) })
            .then((result) => {
            let res = result.value;
            if (res) {
                res = this.transform(res);
            }
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    async deleteMany(filter, fields) {
        let client = await this.connectionPool.connectToDatabase(process.env.MONGODB_CONNECTION_STRING);
        let collection = await client.db().collection(this.collection);
        return collection
            .findOneAndDelete(filter, {
            projection: mongodb_utils_1.MongoDbUtils.parseFields(fields, this.private_fields),
        })
            .then((result) => {
            let res = result.value;
            if (res) {
                res = this.transform(res);
            }
            return res;
        })
            .catch((err) => {
            throw new http_error_1.HttpError(err.message, err, 500);
        });
    }
    getSorting(aggregate, orderBy, ctx) {
        for (let key in orderBy) {
            if (!this.includes[key])
                continue;
            let commands = this.includes[key];
            if (!commands)
                return;
            if (typeof commands === "function") {
                let _function = commands;
                commands = _function(ctx);
            }
            aggregate.push(...commands);
        }
    }
    addIncludes(aggregate, includes, ctx) {
        for (let include of new Set([...this.pre_include, ...includes])) {
            let commands = this.includes[include];
            if (!commands)
                return;
            if (typeof commands === "function") {
                let _function = commands;
                commands = _function(ctx);
            }
            aggregate.push(...commands);
        }
    }
    getAggregate(filter, includes, orderBy, ctx) {
        let aggregate = [{ $match: filter }];
        if (filter["#pre"] || filter["#post"]) {
            aggregate = [];
        }
        if (filter["#pre"])
            aggregate.push({ $match: filter["#pre"] });
        this.addIncludes(aggregate, includes, ctx || {});
        if (filter["#post"])
            aggregate.push({ $match: filter["#post"] });
        this.getSorting(aggregate, orderBy, ctx);
        console.log("Aggregate: ", aggregate);
        return aggregate;
    }
    transform(entity) {
        entity.id = entity._id;
        delete entity._id;
        return _.omit(entity, this.exclude_fields);
    }
}
exports.MongoDBService = MongoDBService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uZ29kYi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NlcnZpY2VzL21vbmdvZGIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0JBQXlCO0FBQ3pCLDBDQUE0QjtBQUU1QixxQ0FBbUM7QUFFbkMsMERBQXNEO0FBQ3RELG9EQUFnRDtBQUdoRCxNQUFNLFVBQVUsR0FBRztJQUNqQixTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDeEIsSUFBSSxTQUFTLEdBQVEsRUFBRSxDQUFDO1FBQ3hCLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFDRCxLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDcEIsSUFBSSxLQUFLLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDbkIsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFDRCxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDbkIsSUFBSSxJQUFJLEdBQVEsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDbEIsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFDRCxLQUFLLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDcEIsSUFBSSxLQUFLLEdBQVEsRUFBRSxDQUFDO1FBQ3BCLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDbkIsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDO0lBQ25CLENBQUM7Q0FDRixDQUFDO0FBRUYsTUFBYSxj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
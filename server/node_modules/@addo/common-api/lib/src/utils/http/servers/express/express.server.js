"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExpressServer = void 0;
const express_1 = __importDefault(require("express"));
const body_parser_1 = __importDefault(require("body-parser"));
class ExpressServer {
    /**
     * Create a Express server with all routes
     *
     * @example
     * import { Response } from "../../models/response";
     * import { ExpressServer } from "./express.server";
     * import { ExpressJsMicroservice, HttpMethod } from "./expressjs.microservice";
     *
     * let endpoint = new ExpressJsMicroservice(
     *    { method: HttpMethod.GET, route: '/hello-world' },
     *    (http) => Promise.resolve<Response<string>>(new Response<string>('Hello world'))
     * );
     * let endpoint1 = new ExpressJsMicroservice(
     *    { method: HttpMethod.GET, route: '/hello-galaxy' },
     *    (http) => Promise.resolve<Response<string>>(new Response<string>('Hello galaxy'))
     * );
     *
     * let server = new ExpressServer(endpoint, endpoint1);
     * server.addMicroservice(
     *    new ExpressJsMicroservice(
     *        { method: HttpMethod.GET, route: '/hello-universe' },
     *        (http) => Promise.resolve<Response<string>>(new Response<string>('Hello universe!'))
     *    )
     * );
     * server.start(8080);
     */
    constructor(...endpoints) {
        this.routes = [];
        console.log(`Creating Express app`);
        this.app = express_1.default();
        this.app.use(body_parser_1.default.urlencoded({ extended: true }));
        this.app.use(body_parser_1.default.json());
        console.log(`Created Express app`);
        for (let microservice of endpoints) {
            this.addMicroservice(microservice);
        }
    }
    getRoutes() {
        return this.routes;
    }
    start(port = null) {
        // let routes = []
        // this.app._router.stack.forEach((r) => {
        //     if (r.route && r.route.path) {
        //         routes.push(r.route);
        //     }
        // })
        this.app.get('/docs/routes', (req, res) => {
            res.status(200).json(this.routes);
        });
        console.log(`======== ROUTES ========`);
        for (let route of this.routes) {
            console.log(`[${route.method}] ${route.route}`);
        }
        console.log(`========================`);
        this.app.listen(port || process.env.PORT, () => console.log(`Express app listening on port ${port || process.env.PORT}!`));
    }
    addMicroservice(microservice) {
        console.log(`Add new route: [${microservice.config.method}] ${microservice.config.route}`);
        this.app[microservice.config.method](microservice.config.route, microservice.getHandler());
        this.routes.push(microservice.config);
    }
}
exports.ExpressServer = ExpressServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy5zZXJ2ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvdXRpbHMvaHR0cC9zZXJ2ZXJzL2V4cHJlc3MvZXhwcmVzcy5zZXJ2ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsc0RBQThCO0FBRTlCLDhEQUFxQztBQUVyQyxNQUFhLGFBQWE7SUFLdEI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0F5Qkc7SUFDSCxZQUFZLEdBQUcsU0FBNEM7UUE1Qm5ELFdBQU0sR0FBcUIsRUFBRSxDQUFDO1FBNkJsQyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxpQkFBTyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMscUJBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLHFCQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUVoQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDbkMsS0FBSyxJQUFJLFlBQVksSUFBSSxTQUFTLEVBQUU7WUFDaEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUN0QztJQUNMLENBQUM7SUFFRCxTQUFTO1FBQ0wsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBZSxJQUFJO1FBQ3JCLGtCQUFrQjtRQUNsQiwwQ0FBMEM7UUFDMUMscUNBQXFDO1FBQ3JDLGdDQUFnQztRQUNoQyxRQUFRO1FBQ1IsS0FBSztRQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUV0QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEMsS0FBSyxJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ25EO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBRXhDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FDM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FDNUUsQ0FBQztJQUNOLENBQUM7SUFFRCxlQUFlLENBQUMsWUFBNkM7UUFDekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUMzRixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDMUMsQ0FBQztDQUNKO0FBM0VELHNDQTJFQyJ9